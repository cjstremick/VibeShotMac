name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build
        run: |
          xcodebuild -project VibeShot/VibeShot.xcodeproj \
            -scheme VibeShot \
            -destination 'platform=macOS' \
            -configuration Release \
            -derivedDataPath build \
            clean build CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO

      - name: Archive
        run: |
          cd build/Build/Products/Release
          zip -r VibeShot.zip VibeShot.app

      - name: Generate Homebrew Cask
        run: |
          cd build/Build/Products/Release
          
          # Calculate SHA256
          SHA256=$(shasum -a 256 VibeShot.zip | awk '{print $1}')
          
          # Get version from tag (strip 'v' prefix)
          VERSION_TAG=${{ github.ref_name }}
          VERSION_NUM=${VERSION_TAG#v}
          
          # Create Cask file
          cat <<EOF > vibeshot.rb
          cask "vibeshot" do
            version "$VERSION_NUM"
            sha256 "$SHA256"

            url "https://github.com/${{ github.repository }}/releases/download/$VERSION_TAG/VibeShot.zip"
            name "VibeShot"
            desc "Screenshot and markup tool"
            homepage "https://github.com/${{ github.repository }}"

            app "VibeShot.app"
          end
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/Build/Products/Release/VibeShot.zip
            build/Build/Products/Release/vibeshot.rb
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/cjstremick/homebrew-tap.git
          mkdir -p homebrew-tap/Casks
          cp build/Build/Products/Release/vibeshot.rb homebrew-tap/Casks/vibeshot.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/vibeshot.rb
          git diff --cached --quiet || git commit -m "Update vibeshot to ${{ github.ref_name }}"
          git push
